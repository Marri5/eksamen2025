<%- include('layout', { body: `
<div class="row justify-content-center">
    <div class="col-12 col-md-8 col-lg-6">
        <h1 class="mb-4">
            <i class="bi bi-cloud-upload"></i> Last opp bilde
        </h1>
        
        <div class="card">
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="imageFile" class="form-label">Velg bilde</label>
                        <input type="file" 
                               class="form-control" 
                               id="imageFile" 
                               name="image" 
                               accept="image/*" 
                               required>
                        <div class="form-text">
                            Tillatte formater: JPG, JPEG, PNG, GIF. Maks størrelse: 5MB
                        </div>
                    </div>
                    
                    <!-- Image preview -->
                    <div id="imagePreview" class="mb-3 text-center d-none">
                        <img src="" alt="Preview" class="img-fluid" style="max-height: 300px;">
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-upload"></i> Last opp
                        </button>
                        <a href="/" class="btn btn-secondary">
                            <i class="bi bi-x-circle"></i> Avbryt
                        </a>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Upload progress -->
        <div id="uploadProgress" class="mt-3 d-none">
            <div class="progress">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" 
                     style="width: 0%">
                </div>
            </div>
        </div>
        
        <!-- Alert messages -->
        <div id="alertContainer" class="mt-3"></div>
    </div>
</div>

<script>
document.getElementById('imageFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file && file.type.startsWith('image/')) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('imagePreview');
            preview.querySelector('img').src = e.target.result;
            preview.classList.remove('d-none');
        };
        reader.readAsDataURL(file);
    }
});

document.getElementById('uploadForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    const fileInput = document.getElementById('imageFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showAlert('Vennligst velg et bilde', 'warning');
        return;
    }
    
    // Check file size (5MB limit)
    if (file.size > 5 * 1024 * 1024) {
        showAlert('Filen er for stor. Maks størrelse er 5MB', 'danger');
        return;
    }
    
    formData.append('image', file);
    
    // Show progress
    const progressDiv = document.getElementById('uploadProgress');
    const progressBar = progressDiv.querySelector('.progress-bar');
    progressDiv.classList.remove('d-none');
    
    try {
        const response = await fetch('http://10.12.91.101:5000/api/images/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showAlert('Bilde lastet opp!', 'success');
            setTimeout(() => {
                window.location.href = '/';
            }, 1500);
        } else {
            showAlert(data.error || 'Feil ved opplasting', 'danger');
        }
    } catch (error) {
        console.error('Upload error:', error);
        showAlert('Nettverksfeil. Prøv igjen senere.', 'danger');
    } finally {
        progressDiv.classList.add('d-none');
        progressBar.style.width = '0%';
    }
});

function showAlert(message, type) {
    const alertContainer = document.getElementById('alertContainer');
    const alert = document.createElement('div');
    alert.className = \`alert alert-\${type} alert-dismissible fade show\`;
    alert.innerHTML = \`
        \${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    \`;
    alertContainer.appendChild(alert);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        alert.remove();
    }, 5000);
}
</script>
` }) %> 